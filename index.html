<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ°´æœOXO - é›²ç«¯ç‰ˆ</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 20px; }
        .app-container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tag { background: #e1f5fe; color: #01579b; padding: 2px 8px; border-radius: 4px; margin-right: 4px; font-size: 12px; display: inline-block; margin-bottom: 2px; }
        .variant-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        select, button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: #f8f9fa; }
        .filter-section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #e9ecef; display: flex; gap: 15px; }
        .filter-group { flex: 1; }
        .filter-group label { font-size: 13px; font-weight: bold; color: #666; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="app-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 id="userTitle" style="margin: 0;">è¼‰å…¥ä¸­...</h2>
        <button onclick="changeUser()" style="width: auto; padding: 5px 12px; background: #95a5a6; color: white; font-size: 13px; margin: 0; border: none; border-radius: 4px; cursor: pointer;">åˆ‡æ›ç”¨æˆ¶</button>
    </div>

    <div id="status" style="color: #666; font-size: 14px; margin-bottom: 10px;">æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</div>
    
    <label>ğŸ 1. é¸æ“‡æ°´æœ</label>
    <select id="fruitSelect"></select>

    <label style="display:block; margin-top:15px;">ğŸ§¬ 2. å‹¾é¸è®Šç•°</label>
    <div id="variantGrid" class="variant-grid"></div>

    <button onclick="uploadData()" style="background:#27ae60; color:white; border:none; cursor:pointer; font-weight: bold;">ä¸Šå‚³ç´€éŒ„åˆ°é›²ç«¯</button>

    <hr style="margin: 25px 0; border: 0; border-top: 2px solid #eee;">
    
    <h3>ğŸ“‹ æ°´æœæ¸…å–®</h3>
    <div class="filter-section">
        <div class="filter-group">
            <label>æŒ‰æ°´æœéæ¿¾</label>
            <select id="filterFruit" onchange="renderTable()"></select>
        </div>
        <div class="filter-group">
            <label>æŒ‰è®Šç•°éæ¿¾</label>
            <select id="filterVariant" onchange="renderTable()"></select>
        </div>
    </div>

    <table id="cloudTable">
        <thead><tr><th>ä½¿ç”¨è€…</th><th>æ°´æœ</th><th>è®Šç•°ç‹€æ…‹</th></tr></thead>
        <tbody id="cloudBody"></tbody>
    </table>
</div>

<script>
    // âš ï¸ å·²ç¶“å¹«ä½ å¡«å¥½ä½ å‰›æ‰æˆªåœ–è£¡çš„ URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyTvktZusu1atKjQZbzi_dommNgilruZoQvE2Vfwuz1CxY7T_c8JZXBzNppQZLjeKw7/exec";
    
    const fruits = {"ç´…ç¾…è””":"ğŸ¥•","è‰è“":"ğŸ“","è—è“":"ğŸ«","è¥¿ç“œ":"ğŸ‰","å—ç“œ":"ğŸƒ","äººåƒ":"ğŸ¥—","è˜‹æœ":"ğŸ","ç”Ÿèœ":"ğŸ¥¬","æ³¢èœ":"ğŸƒ","ç•ªèŒ„":"ğŸ…","è‘¡è„":"ğŸ‡","ä»™äººæŒ":"ğŸŒµ","æ¤°å­":"ğŸ¥¥","é‡‹è¿¦":"ğŸˆ","ç‰ç±³":"ğŸŒ½","æ¦´æ§¤":"ğŸˆ","èŠ’æœ":"ğŸ¥­","æª¸æª¬":"ğŸ‹","è˜‘è‡":"ğŸ„","ç¢—è±†":"ğŸ«›"};
    const variants = ["é‡‘å…‰", "å½©è™¹", "æ½®æ¿•", "é›»æ“Š", "é¢³é¢¨", "æ²™å¡µ", "æœˆå…‰", "æ¥µå…‰", "éœ²ç ", "ä¹¾ç‡¥", "å¹»è±¡", "ç„¡"];
    
    let allCloudData = []; 
    let currentUser = sessionStorage.getItem('activeUser');

    // å•Ÿå‹•æ™‚ç«‹åˆ»è©¢å•å§“å
    if (!currentUser || currentUser === "null") {
        currentUser = prompt("è«‹è¼¸å…¥æ‚¨çš„åç¨±ï¼š") || "å¤©ç«ºé¼ ";
        sessionStorage.setItem('activeUser', currentUser);
    }

    function init() {
        document.getElementById('userTitle').innerText = "ä½ å¥½ï¼Œ" + currentUser;

        // åˆå§‹åŒ–é¸æ“‡é¸å–®
        const fs = document.getElementById('fruitSelect');
        const ff = document.getElementById('filterFruit');
        ff.add(new Option("é¡¯ç¤ºå…¨éƒ¨æ°´æœ", "ALL"));
        for (let f in fruits) {
            fs.add(new Option(fruits[f] + " " + f, f));
            ff.add(new Option(fruits[f] + " " + f, f));
        }

        // åˆå§‹åŒ–è®Šç•°å‹¾é¸æ¡†èˆ‡éæ¿¾é¸å–®
        const vg = document.getElementById('variantGrid');
        const fv = document.getElementById('filterVariant');
        fv.add(new Option("é¡¯ç¤ºå…¨éƒ¨è®Šç•°", "ALL"));
        variants.forEach(v => {
            vg.innerHTML += `<label style="display:inline-block; margin-right:10px;"><input type="checkbox" name="vCheck" value="${v}"> ${v}</label>`;
            fv.add(new Option(v, v));
        });

        loadCloudData();
    }

    async function loadCloudData() {
        try {
            const resp = await fetch(SCRIPT_URL);
            allCloudData = await resp.json();
            renderTable();
            document.getElementById('status').innerText = "âœ… é›²ç«¯åŒæ­¥æˆåŠŸ";
        } catch (e) {
            document.getElementById('status').innerText = "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
        }
    }

    function renderTable() {
        const filterF = document.getElementById('filterFruit').value;
        const filterV = document.getElementById('filterVariant').value;
        const tbody = document.getElementById('cloudBody');
        tbody.innerHTML = '';

        if (!allCloudData || allCloudData.length === 0) return;

        const filtered = allCloudData.filter(row => {
            const matchFruit = (filterF === "ALL" || row[2] === filterF);
            const matchVariant = (filterV === "ALL" || (row[3] && row[3].includes(filterV)));
            return matchFruit && matchVariant;
        }).reverse();

        filtered.forEach(row => {
            const tr = document.createElement('tr');
            const tags = row[3] ? row[3].split(', ').map(t => `<span class="tag">${t}</span>`).join('') : '';
            tr.innerHTML = `
                <td>${row[1]}</td>
                <td><strong>${fruits[row[2]] || ''} ${row[2]}</strong></td>
                <td>${tags}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function uploadData() {
        const fruit = document.getElementById('fruitSelect').value;
        const selected = Array.from(document.querySelectorAll('input[name="vCheck"]:checked')).map(cb => cb.value);
        if (selected.length === 0) return alert("è«‹å‹¾é¸è®Šç•°");

        document.getElementById('status').innerText = "ğŸš€ ä¸Šå‚³ä¸­...";
        try {
            await fetch(SCRIPT_URL, {
                method: "POST",
                mode: 'no-cors', // è§£æ±ºè·¨ç¶²åŸŸå ±éŒ¯
                body: JSON.stringify({ id: Date.now(), user: currentUser, fruit: fruit, variants: selected })
            });
            alert("ä¸Šå‚³æˆåŠŸï¼");
            document.querySelectorAll('input[name="vCheck"]').forEach(cb => cb.checked = false);
            setTimeout(loadCloudData, 1500); // å»¶é²ä¸€ä¸‹å†é‡æ–°æŠ“è³‡æ–™
        } catch (e) {
            alert("ä¸Šå‚³å®Œæˆ");
            loadCloudData();
        }
    }

    function changeUser() {
        const newUser = prompt("è«‹è¼¸å…¥æ–°ä½¿ç”¨è€…åç¨±ï¼š");
        if (newUser) {
            sessionStorage.setItem('activeUser', newUser);
            location.reload();
        }
    }

    // ç¢ºä¿ç¶²é è¼‰å…¥å¾Œæ‰åŸ·è¡Œ init
    window.onload = init;
</script>
</body>
</html>

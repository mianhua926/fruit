<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ°´æœOXO</title>
    <style>
        /* ä¿ç•™ä½ ä¹‹å‰çš„æ¨£å¼ä¸¦å„ªåŒ– */
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 20px; }
        .app-container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; }
        .tag { background: #e1f5fe; color: #01579b; padding: 2px 8px; border-radius: 4px; margin-right: 4px; font-size: 12px; }
        .variant-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        select, button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
    </style>
</head>
<body>

<div class="app-container">
    <h2 id="userTitle">é›²ç«¯åŒæ­¥å¾Œå°</h2>
    <div id="status">æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</div>
    
    <label>1. é¸æ“‡æ°´æœ</label>
    <select id="fruitSelect"></select>

    <label style="display:block; margin-top:15px;">2. å‹¾é¸è®Šç•°</label>
    <div id="variantGrid" class="variant-grid"></div>

    <button onclick="uploadData()" style="background:#27ae60; color:white; border:none; cursor:pointer;">ä¸Šå‚³ç´€éŒ„åˆ°é›²ç«¯</button>

    <hr>
    <h3>ğŸ“‹æ°´æœæ¸…å–®</h3>
    <div class="filter-section" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #e9ecef; display: flex; gap: 15px;">
    <div class="filter-group" style="flex: 1;">
        <label style="font-size: 13px; font-weight: bold; color: #666; display: block; margin-bottom: 5px;">æŒ‰æ°´æœéæ¿¾</label>
        <select id="filterFruit" onchange="renderTable()" style="margin-top: 0; padding: 8px; font-size: 14px; width: 100%; border-radius: 6px;"></select>
    </div>
    <div class="filter-group" style="flex: 1;">
        <label style="font-size: 13px; font-weight: bold; color: #666; display: block; margin-bottom: 5px;">æŒ‰è®Šç•°éæ¿¾</label>
        <select id="filterVariant" onchange="renderTable()" style="margin-top: 0; padding: 8px; font-size: 14px; width: 100%; border-radius: 6px;"></select>
    </div>
</div>
    <table id="cloudTable">
        <thead><tr><th>ä½¿ç”¨è€…</th><th>æ°´æœ</th><th>è®Šç•°ç‹€æ…‹</th></tr></thead>
        <tbody id="cloudBody"></tbody>
    </table>
</div>

<script>
    // âš ï¸ è«‹åœ¨é€™è£¡è²¼ä¸Šä½ çš„ Apps Script ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyTvktZusu1atKjQZbzi_dommNgilruZoQvE2Vfwuz1CxY7T_c8JZXBzNppQZLjeKw7/exec";
    
    const fruits = {"ç´…ç¾…è””":"ğŸ¥•","è‰è“":"ğŸ“","è—è“":"ğŸ«","è¥¿ç“œ":"ğŸ‰","å—ç“œ":"ğŸƒ","äººåƒ":"ğŸ¥—","è˜‹æœ":"ğŸ","ç”Ÿèœ":"ğŸ¥¬","æ³¢èœ":"ğŸƒ","ç•ªèŒ„":"ğŸ…","è‘¡è„":"ğŸ‡","ä»™äººæŒ":"ğŸŒµ","æ¤°å­":"ğŸ¥¥","é‡‹è¿¦":"ğŸˆ","ç‰ç±³":"ğŸŒ½","æ¦´æ§¤":"ğŸˆ","èŠ’æœ":"ğŸ¥­","æª¸æª¬":"ğŸ‹","è˜‘è‡":"ğŸ„","ç¢—è±†":"ğŸ«›"};
    const variants = ["é‡‘å…‰", "å½©è™¹", "æ½®æ¿•", "é›»æ“Š", "é¢³é¢¨", "æ²™å¡µ", "æœˆå…‰", "æ¥µå…‰", "éœ²ç ", "ä¹¾ç‡¥", "å¹»è±¡", "ç„¡"];
    const currentUser = sessionStorage.getItem('activeUser') || prompt("è«‹è¼¸å…¥æ‚¨çš„åç¨±") || "å¤©ç«ºé¼ ";
    sessionStorage.setItem('activeUser', currentUser);
    document.getElementById('userTitle').innerText = "ä½ å¥½ï¼Œ" + currentUser;

    function init() {
        // åœ¨ init() è£¡é¢åŠ å…¥é€™æ®µ
const ff = document.getElementById('filterFruit');
ff.add(new Option("é¡¯ç¤ºå…¨éƒ¨æ°´æœ", "ALL"));
for (let f in fruits) {
    ff.add(new Option(fruits[f] + " " + f, f));
}

const fv = document.getElementById('filterVariant');
fv.add(new Option("é¡¯ç¤ºå…¨éƒ¨è®Šç•°", "ALL"));
variants.forEach(v => {
    fv.add(new Option(v, v));
});
        const fs = document.getElementById('fruitSelect');
        for (let f in fruits) fs.add(new Option(fruits[f] + " " + f, f));

        const vg = document.getElementById('variantGrid');
        variants.forEach(v => {
            vg.innerHTML += `<label><input type="checkbox" name="vCheck" value="${v}"> ${v}</label>`;
        });
        loadCloudData();
    }

    async function loadCloudData() {
    try {
        const resp = await fetch(SCRIPT_URL);
        allCloudData = await resp.json(); // ç¢ºä¿è³‡æ–™å­˜é€² allCloudData
        renderTable(); // <--- é—œéµï¼é€™è¡Œæœƒå»è§¸ç™¼ç•«è¡¨æ ¼çš„å‹•ä½œ
        document.getElementById('status').innerText = "âœ… é›²ç«¯åŒæ­¥æˆåŠŸ";
    } catch (e) {
        document.getElementById('status').innerText = "âŒ é€£ç·šå¤±æ•—";
    }
}
    }

    async function uploadData() {
        const fruit = document.getElementById('fruitSelect').value;
        const selected = Array.from(document.querySelectorAll('input[name="vCheck"]:checked')).map(cb => cb.value);
        if (selected.length === 0) return alert("è«‹å‹¾é¸è®Šç•°");

        document.getElementById('status').innerText = "ğŸš€ ä¸Šå‚³ä¸­...";
        await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ id: Date.now(), user: currentUser, fruit: fruit, variants: selected })
        });
        
        document.querySelectorAll('input[name="vCheck"]').forEach(cb => cb.checked = false);
        loadCloudData();
    }

    init();

function renderTable() {
    const filterF = document.getElementById('filterFruit').value;
    const filterV = document.getElementById('filterVariant').value;
    const tbody = document.getElementById('cloudBody');
    tbody.innerHTML = '';

    // ç¯©é¸é‚è¼¯
    const filtered = allCloudData.filter(row => {
        const matchFruit = (filterF === "ALL" || row[2] === filterF);
        const matchVariant = (filterV === "ALL" || row[3].includes(filterV));
        return matchFruit && matchVariant;
    }).reverse();

    filtered.forEach(row => {
        const tr = document.createElement('tr');
        // row[3] æ˜¯è®Šç•°å­—ä¸²ï¼Œç”¨é€—è™Ÿæ‹†é–‹è®Šæˆæ¨™ç±¤
        const tags = row[3].split(', ').map(t => `<span class="tag">${t}</span>`).join('');
        tr.innerHTML = `
            <td>${row[1]}</td>
            <td><strong>${fruits[row[2]] || ''} ${row[2]}</strong></td>
            <td>${tags}</td>
        `;
        tbody.appendChild(tr);
    });
}
</script>
</body>
</html>

